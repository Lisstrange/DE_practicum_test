# DE_practicum_test

ETL скрипт для выгрузки данных через api с использованием docker и airflow + postgres

Код разрабатывался под чип apple silicon

<h3> Инструкция: </h3>

1) Скачать данный репозиторий к себе на компьютер
2) В корневой директории вызвать команду ```docker compose up```
3) Подключиться к базе данных черех удобные для вас утилиты (см <b><a href="#Connection"> параметры
   подключения</a></b>):
4) Зайти и авторизоваться на airflow по ссылке - http://localhost:8080/ . Логин - _airflow_ пароль - _airflow_
5) Перейти во вкладку DAG и запустить скрипт <a>yandex-practicum-load-currency</a>

<p> 
   <a id="Connection"> Параметры подключения:</a>
   <ul>
      <li>
         Хост - localhost
      </li>
      <li>
         База данных - yandex
      </li>
      <li>
         Порт - 5442
      </li>
      <li>
         Пользователь - postgres
      </li>
      <li>
         Пароль - postgres
      </li>
      <li>
         Таблица - currency_pair
      </li>
   </ul>

<p>
<h3> Что было сделано: </h3>

1) Создан образ airflow в сответствии с
   документацией (https://airflow.apache.org/docs/apache-airflow/stable/start/docker.html)
2) Добавлена БД postgres https://hub.docker.com/_/postgres .Настроен volume для сохранения данных и создана схема при
   инициализации контейнера + реализовано автоматическое создание таблиц
3) Написан класс PgHandler для работы с БД через psycorg2. Нужен, чтобы каждый раз не открывать/закрывать соединение.
4) Создан DAG файл с последовательностью задач (start_bash_task >> get_start_ctn_rows >> load_data >> insert_data >> insert_process_control >> end_task)

Для базовой валидации добавлен PythonSensor - insert_process_control, который позволяет контролировать изменение состояния таблицы
Передача данных из load_data в insert_data осуществляется через xcom

<h4> Что стоит доделать: </h4>

1) Добавить проверку на сравнение макимальной даты источника с текущей. + Реализовать догрузку данных до текущей через Historical Rates Endpoint. (Задание под звёздочкой)
2) Декомпозировать все компоненты и вынести их в отдельные файлы (Классы для БД, основные скрипты и задачи, DAG файл)
3) Убрать загруженные DAG файлы примеры
4) Автоматизировать подключение к БД на этапе запуска контейнера 